<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>King's Escape</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --light: #f0d9b5; --dark: #b58863; --win: #4CAF50; --accent: #7b61ff; }
        body { background: #1a1a1a; color: white; display: flex; flex-direction: column; align-items: center; font-family: 'Segoe UI', sans-serif; }

        /* Layout & Panelen */
        .game-container { display: flex; align-items: center; gap: 30px; margin-top: 20px; }
        .captured-panel { width: 100px; min-height: 480px; background: #2a2a2a; border-radius: 8px; padding: 10px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 5px; border: 2px solid #333; }
        .captured-panel img { width: 35px; height: 35px; }

        #timer { font-size: 2.5rem; font-weight: bold; color: #ff4d4d; margin: 10px 0; font-family: monospace; }
        #status { font-size: 1.2rem; padding: 10px 20px; background: #333; border-radius: 20px; margin-bottom: 10px; min-width: 300px; text-align: center; }

        /* Bord */
        .board-container { position: relative; padding: 70px; background: #2a2a2a; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.6); }
        .board { display: grid; grid-template-columns: repeat(8, 60px); grid-template-rows: repeat(8, 60px); border: 4px solid #111; }
        .sq { width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; cursor: pointer; position: relative; }
        .sq img { width: 85%; height: 85%; z-index: 2; pointer-events: none; }
        .light { background-color: var(--light); }
        .dark { background-color: var(--dark); }

        /* Speciale velden */
        .extra-sq { position: absolute; width: 54px; height: 54px; border: 3px dashed gold; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        #t-0-2 { top: 14px; left: 193px; background: var(--dark); }
        #t-0-5 { top: 14px; left: 373px; background: var(--light); }
        #b-7-2 { bottom: 13px; left: 193px; background: var(--light); }
        #b-7-5 { bottom: 13px; left: 373px; background: var(--dark); }

        /* Highlights */
        .selected { background-color: var(--accent) !important; }
        .possible::after { content: ''; position: absolute; width: 16px; height: 16px; background: rgba(0,0,0,0.3); border-radius: 50%; }
        .last-move { background-color: rgba(255, 255, 0, 0.4) !important; }
        .status-win { background: var(--win) !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <div id="menu" style="margin-top: 20px;">
        <button id="copyLinkBtn" onclick="copyGameLink()" style="padding: 10px 20px; background: var(--accent); color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold;">?? Deel uitnodiging</button>
    </div>

    <div id="timer">02:00</div>
    <div id="status">Verbinden...</div>

    <div class="game-container">
        <div id="captured-black" class="captured-panel"></div>

        <div class="board-container">
            <div id="t-0-2" class="extra-sq" onclick="handleSelect('t-0-2')"></div>
            <div id="t-0-5" class="extra-sq" onclick="handleSelect('t-0-5')"></div>
            <div id="board" class="board"></div>
            <div id="b-7-2" class="extra-sq" onclick="handleSelect('b-7-2')"></div>
            <div id="b-7-5" class="extra-sq" onclick="handleSelect('b-7-5')"></div>
        </div>

        <div id="captured-white" class="captured-panel"></div>
    </div>

    <script>
        const socket = io(window.location.origin);
        let myColor, turn = 'white', selectedId = null, gameActive = false;
        let timeLeft = 120;
        let timerInterval;

        const urlParams = new URLSearchParams(window.location.search);
        let room = urlParams.get('room') || "schaak-" + Math.floor(Math.random() * 1000);
        if (!urlParams.get('room')) window.history.pushState({}, '', '?room=' + room);

        const imgs = {
            'p': 'https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg', 'r': 'https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg',
            'n': 'https://upload.wikimedia.org/wikipedia/commons/e/ef/Chess_ndt45.svg', 'b': 'https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg',
            'q': 'https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg', 'k': 'https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg',
            'P': 'https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg', 'R': 'https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg',
            'N': 'https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg', 'B': 'https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg',
            'Q': 'https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg', 'K': 'https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg'
        };

        const initialSetup = {
            '0-0':'r','0-1':'n','0-2':'b','0-3':'q','0-4':'k','0-5':'b','0-6':'n','0-7':'r',
            '1-0':'p','1-1':'p','1-2':'p','1-3':'p','1-4':'p','1-5':'p','1-6':'p','1-7':'p',
            '6-0':'P','6-1':'P','6-2':'P','6-3':'P','6-4':'P','6-5':'P','6-6':'P','6-7':'P',
            '7-0':'R','7-1':'N','7-2':'B','7-3':'Q','7-4':'K','7-5':'B','7-6':'N','7-7':'R'
        };

        function initBoard(setupData = initialSetup) {
            const board = document.getElementById('board');
            board.innerHTML = '';
            for(let r=0; r<8; r++) {
                for(let c=0; c<8; c++) {
                    const s = document.createElement('div');
                    s.className = `sq ${(r+c)%2===0?'light':'dark'}`;
                    s.id = `${r}-${c}`;
                    if(setupData[s.id]) s.innerHTML = `<img src="${imgs[setupData[s.id]]}" data-piece="${setupData[s.id]}">`;
                    s.onclick = () => handleSelect(s.id);
                    board.appendChild(s);
                }
            }
        }

        function startTimer() {
            clearInterval(timerInterval);
            timeLeft = 120;
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                if (!gameActive) return;
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    if (turn === myColor) socket.emit('timeOut', { room, color: myColor });
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const mins = Math.floor(timeLeft / 60);
            const secs = timeLeft % 60;
            document.getElementById('timer').innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        function handleSelect(id) {
            if(!gameActive || turn !== myColor) return;
            const el = document.getElementById(id);

            if(selectedId && el.classList.contains('possible')) {
                const movingPiece = document.getElementById(selectedId).querySelector('img').dataset.piece;
                const targetPiece = el.querySelector('img')?.dataset.piece || null;

                applyMove(selectedId, id, movingPiece);
                socket.emit('makeMove', {
                    room, from: selectedId, to: id, piece: movingPiece,
                    capturedPiece: targetPiece, turn, currentBoard: getBoardState()
                });
                checkVictoryConditions(id, movingPiece);
            } else {
                clearHighlights();
                const img = el.querySelector('img');
                if(img && isOwn(img.dataset.piece)) {
                    selectedId = id;
                    el.classList.add('selected');
                    showValidMoves(id, img.dataset.piece);
                }
            }
        }

        function applyMove(f, t, p, isSync = false) {
            const fromEl = document.getElementById(f);
            const toEl = document.getElementById(t);

            if(toEl.innerHTML !== '') {
                addCapturedPiece(toEl.querySelector('img').dataset.piece);
            }

            document.querySelectorAll('.sq, .extra-sq').forEach(s => s.classList.remove('last-move'));
            fromEl.classList.add('last-move');
            toEl.classList.add('last-move');

            toEl.innerHTML = `<img src="${imgs[p]}" data-piece="${p}">`;
            fromEl.innerHTML = '';

            turn = turn === 'white' ? 'black' : 'white';
            if (!isSync) startTimer();
            clearHighlights();
            updateUI();
        }

        function addCapturedPiece(p) {
            const owner = p === p.toUpperCase() ? 'black' : 'white';
            const container = document.getElementById(`captured-${owner}`);
            container.innerHTML += `<img src="${imgs[p]}">`;
        }

        function getBoardState() {
            const state = {};
            document.querySelectorAll('.sq').forEach(s => {
                if(s.querySelector('img')) state[s.id] = s.querySelector('img').dataset.piece;
            });
            return state;
        }

        function isOwn(p) { return myColor === 'white' ? p === p.toUpperCase() : p === p.toLowerCase(); }

        // Socket Events
        socket.emit('joinGame', room);
        socket.on('playerColor', c => { myColor = c; updateUI(); });
        socket.on('startGame', () => { gameActive = true; startTimer(); updateUI(); });
        socket.on('moveMade', d => applyMove(d.from, d.to, d.piece));
        socket.on('winner', w => declareWinner(w));

        socket.on('syncState', state => {
            initBoard(state.board);
            document.getElementById('captured-white').innerHTML = '';
            document.getElementById('captured-black').innerHTML = '';
            state.captured.white.forEach(p => addCapturedPiece(p));
            state.captured.black.forEach(p => addCapturedPiece(p));
            turn = state.turn;
            if (state.lastMove) {
                document.getElementById(state.lastMove.from).classList.add('last-move');
                document.getElementById(state.lastMove.to).classList.add('last-move');
            }
            gameActive = true;
            startTimer();
            updateUI();
        });

        // Schaak Logica (verkort)
        function showValidMoves(id, p) {
            const [r, c] = id.split('-').length > 1 ? id.split('-').map(Number) : [null, null];
            const dirs = { 'R': [[1,0],[-1,0],[0,1],[0,-1]], 'B': [[1,1],[1,-1],[-1,1],[-1,-1]], 'N': [[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]] };
            const type = p.toUpperCase();
            if(type === 'R') slide(r, c, dirs.R);
            if(type === 'B') slide(r, c, dirs.B);
            if(type === 'Q') slide(r, c, [...dirs.R, ...dirs.B]);
            if(type === 'N') dirs.N.forEach(m => step(r+m[0], c+m[1]));
            if(type === 'K') {
                [...dirs.R, ...dirs.B].forEach(m => step(r+m[0], c+m[1]));
                if(myColor === 'white' && r === 0) { if(c === 2) highlight('t-0-2'); if(c === 5) highlight('t-0-5'); }
                if(myColor === 'black' && r === 7) { if(c === 2) highlight('b-7-2'); if(c === 5) highlight('b-7-5'); }
            }
            if(type === 'P') {
                let d = (p === 'P') ? -1 : 1, start = (p === 'P') ? 6 : 1;
                if(!hasPiece(`${r+d}-${c}`)) { highlight(`${r+d}-${c}`); if(r === start && !hasPiece(`${r+2*d}-${c}`)) highlight(`${r+2*d}-${c}`); }
                [1,-1].forEach(side => { let tid = `${r+d}-${c+side}`; if(hasPiece(tid) && !isOwnPieceAt(tid)) highlight(tid); });
            }
        }
        function slide(r, c, dirs) {
            dirs.forEach(d => {
                let nr=r+d[0], nc=c+d[1];
                while(nr>=0 && nr<8 && nc>=0 && nc<8) {
                    let tid = `${nr}-${nc}`;
                    if(!hasPiece(tid)) { highlight(tid); } else { if(!isOwnPieceAt(tid)) highlight(tid); break; }
                    nr+=d[0]; nc+=d[1];
                }
            });
        }
        function step(r, c) { if(r>=0 && r<8 && c>=0 && c<8) { let tid = `${r}-${c}`; if(!hasPiece(tid) || !isOwnPieceAt(tid)) highlight(tid); } }
        function highlight(id) { const el = document.getElementById(id); if(el) el.classList.add('possible'); }
        function hasPiece(id) { let el = document.getElementById(id); return el && el.innerHTML !== ''; }
        function isOwnPieceAt(id) { let el = document.getElementById(id); return el && el.querySelector('img') && isOwn(el.querySelector('img').dataset.piece); }
        function clearHighlights() { document.querySelectorAll('.sq, .extra-sq').forEach(s => s.classList.remove('selected', 'possible')); selectedId = null; }

        function checkVictoryConditions(id, p) {
            if((p === 'K' && id.startsWith('t')) || (p === 'k' && id.startsWith('b'))) {
                socket.emit('gameOver', { room, winner: p === 'K' ? 'WIT' : 'ZWART' });
            }
        }

        function declareWinner(color) {
            gameActive = false;
            clearInterval(timerInterval);
            const s = document.getElementById('status');
            s.innerText = `${color} HEEFT GEWONNEN!`;
            s.className = 'status-win';
        }

        function updateUI() {
            const s = document.getElementById('status');
            if (!gameActive) { s.innerText = "Wachten op tegenstander..."; return; }
            s.innerText = turn === myColor ? "JOUW BEURT" : "WACHTEN OP TEGENSTANDER...";
            s.style.border = turn === myColor ? "2px solid var(--accent)" : "2px solid #555";
        }

        function copyGameLink() {
            navigator.clipboard.writeText(window.location.href);
            alert("Link gekopieerd!");
        }

        initBoard();
    </script>
</body>
</html>