<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>King's Escape</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --light: #f0d9b5; --dark: #b58863; --win: #4CAF50; --accent: #7b61ff; }
        body { background: #1a1a1a; color: white; display: flex; flex-direction: column; align-items: center; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }

        .board-container { position: relative; padding: 80px; background: #2a2a2a; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.6); margin-top: 20px; }
        .board { display: grid; grid-template-columns: repeat(8, 60px); grid-template-rows: repeat(8, 60px); border: 4px solid #111; }

        .sq { width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; cursor: pointer; position: relative; transition: background 0.2s; }
        .sq img { width: 85%; height: 85%; pointer-events: none; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 2; }
        .light { background-color: var(--light); }
        .dark { background-color: var(--dark); }

        /* Extra vakken */
        .extra-sq { position: absolute; width: 54px; height: 54px; border: 3px dashed gold; display: flex; justify-content: center; align-items: center; cursor: pointer; }
           #t-0-2 { top: 24px; left: 203px; background: var(--dark); }
           #t-0-5 { top: 24px; left: 383px; background: var(--light); }
           #b-7-2 { bottom: 23px; left: 203px; background: var(--light); }
        #b-7-5 { bottom: 23px; left: 383px; background: var(--dark); }

        /* Status & Feedback */
        #status { font-size: 1.4rem; font-weight: bold; margin: 20px; padding: 15px 30px; background: #333; border-radius: 30px; border: 2px solid #555; min-width: 350px; text-align: center; transition: all 0.3s; }
        .status-win { background: var(--win) !important; color: white; border-color: gold !important; transform: scale(1.1); box-shadow: 0 0 20px gold; }

        /* Indicatoren */
        .selected { background-color: var(--accent) !important; }
        .possible::after { content: ''; position: absolute; width: 16px; height: 16px; background: rgba(0,0,0,0.2); border-radius: 50%; z-index: 5; }
        .in-check { background-color: #ff4d4d !important; animation: pulse 1s infinite; }

        /* Animaties */
        @keyframes pulse { 0% { box-shadow: inset 0 0 5px red; } 50% { box-shadow: inset 0 0 25px red; } 100% { box-shadow: inset 0 0 5px red; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .capture-anim { animation: shake 0.3s ease-in-out; }
        .fade-out { opacity: 0; transform: scale(0.5) rotate(20deg); transition: all 0.4s; }

        /* Nieuwe stijlen */
		.main-layout { display: flex; align-items: center; gap: 20px; }
		.captured-box { width: 120px; height: 480px; background: #2a2a2a; border-radius: 8px; padding: 10px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 5px; border: 1px solid #444; }
		.captured-box img { width: 30px; height: 30px; }
		.last-move { background-color: rgba(255, 255, 0, 0.4) !important; }
		#timer { font-family: monospace; font-size: 2rem; color: #ff4d4d; margin-bottom: 10px; }


    </style>
</head>
<body>
<div id="menu">
    <button id="copyLinkBtn" onclick="copyGameLink()" style="display:none;">?? Deel uitnodiging</button>
</div>

<style>
    #menu { margin-bottom: 10px; }
    #copyLinkBtn {
        padding: 10px 20px;
        background: var(--accent);
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-weight: bold;
        transition: 0.3s;
    }
    #copyLinkBtn:hover { transform: scale(1.05); background: #917aff; }
</style>
   <center><img src="logo.png"></center>
   <div id="timer">02:00</div>
   <div id="status">Verbinden met server...</div>

   <div class="main-layout">
       <div id="captured-black" class="captured-box"></div> <div class="board-container">
           <div id="board" class="board"></div>
       </div>
    <div id="captured-white" class="captured-box"></div> </div>

    <div class="board-container">
        <div id="t-0-2" class="extra-sq" onclick="handleSelect('t-0-2')"></div>
        <div id="t-0-5" class="extra-sq" onclick="handleSelect('t-0-5')"></div>
        <div id="board" class="board"></div>
        <div id="b-7-2" class="extra-sq" onclick="handleSelect('b-7-2')"></div>
        <div id="b-7-5" class="extra-sq" onclick="handleSelect('b-7-5')"></div>
    </div>

    <script>
    let timeLeft = 120;
	let timerInterval;

	function startTimer() {
	    clearInterval(timerInterval);
	    timeLeft = 120;
	    updateTimerDisplay();
	    timerInterval = setInterval(() => {
	        if (!gameActive) return;
	        timeLeft--;
	        updateTimerDisplay();
	        if (timeLeft <= 0) {
	            clearInterval(timerInterval);
	            if (turn === myColor) socket.emit('timeOut', { room, color: myColor });
	        }
	    }, 1000);
	}

	function updateTimerDisplay() {
	    const mins = Math.floor(timeLeft / 60);
	    const secs = timeLeft % 60;
	    document.getElementById('timer').innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
}


        //const socket = io();
        const socket = io(window.location.origin);

        let myColor, turn = 'white', selectedId = null, gameActive = false;


        // Zoek of er al een kamer in de URL staat, anders vraag erom
		const urlParams = new URLSearchParams(window.location.search);
		let room = urlParams.get('room');

		if (!room) {
		    room = prompt("Voer kamernaam in:", "schaak-room-" + Math.floor(Math.random() * 1000));
		    // Update de URL zonder de pagina te herladen
		    window.history.pushState({}, '', '?room=' + room);
		}

		// Toon de kopieerknop nu de kamer bekend is
		document.getElementById('copyLinkBtn').style.display = 'block';

		function copyGameLink() {
		    const link = window.location.href;
		    navigator.clipboard.writeText(link).then(() => {
		        const btn = document.getElementById('copyLinkBtn');
		        const originalText = btn.innerText;
		        btn.innerText = "? Gekopieerd!";
		        setTimeout(() => btn.innerText = originalText, 2000);
		    });
}




        const escapeSound = new Audio("/sounds/escape.mp3");
		escapeSound.volume = 0.6;

        const imgs = {
            'p': 'https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg',
            'r': 'https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg',
            'n': 'https://upload.wikimedia.org/wikipedia/commons/e/ef/Chess_ndt45.svg',
            'b': 'https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg',
            'q': 'https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg',
            'k': 'https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg',
            'P': 'https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg',
            'R': 'https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg',
            'N': 'https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg',
            'B': 'https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg',
            'Q': 'https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg',
            'K': 'https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg'
        };

        const setup = {
            '0-0':'r','0-1':'n','0-2':'b','0-3':'q','0-4':'k','0-5':'b','0-6':'n','0-7':'r',
            '1-0':'p','1-1':'p','1-2':'p','1-3':'p','1-4':'p','1-5':'p','1-6':'p','1-7':'p',
            '6-0':'P','6-1':'P','6-2':'P','6-3':'P','6-4':'P','6-5':'P','6-6':'P','6-7':'P',
            '7-0':'R','7-1':'N','7-2':'B','7-3':'Q','7-4':'K','7-5':'B','7-6':'N','7-7':'R'
        };

        function init() {
            const board = document.getElementById('board');
            for(let r=0; r<8; r++) {
                for(let c=0; c<8; c++) {
                    const s = document.createElement('div');
                    s.className = `sq ${(r+c)%2===0?'light':'dark'}`;
                    s.id = `${r}-${c}`;
                    if(setup[s.id]) s.innerHTML = `<img src="${imgs[setup[s.id]]}" data-piece="${setup[s.id]}">`;
                    s.onclick = () => handleSelect(s.id);
                    board.appendChild(s);
                }
            }
        }

        socket.emit('joinGame', room);
        socket.on('playerColor', c => { myColor = c; document.getElementById('status').innerText = `Jij bent ${c === 'white' ? 'Wit' : 'Zwart'}. Wachten...`; });
        socket.on('startGame', () => { gameActive = true; updateUI(); });
        socket.on('moveMade', d => applyMove(d.from, d.to, d.piece));
        socket.on('winner', w => declareWinner(w));

        function handleSelect(id) {
            if(!gameActive || turn !== myColor) return;
            const el = document.getElementById(id);

            if(selectedId && el.classList.contains('possible')) {
                const movingPiece = document.getElementById(selectedId).querySelector('img').dataset.piece;
                socket.emit('makeMove', { room, from: selectedId, to: id, piece: movingPiece });
                applyMove(selectedId, id, movingPiece);
                checkVictoryConditions(id, movingPiece);
            } else {
                clearHighlights();
                const img = el.querySelector('img');
                if(img && isOwn(img.dataset.piece)) {
                    selectedId = id;
                    el.classList.add('selected');
                    showValidMoves(id, img.dataset.piece);
                }
            }
        }

        function isOwn(p) { return myColor === 'white' ? p === p.toUpperCase() : p === p.toLowerCase(); }

        function showValidMoves(id, p) {
            const [r, c] = id.split('-').length > 1 ? id.split('-').map(Number) : [null, null];
            const dirs = { 'R': [[1,0],[-1,0],[0,1],[0,-1]], 'B': [[1,1],[1,-1],[-1,1],[-1,-1]], 'N': [[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]] };
            const type = p.toUpperCase();

            if(type === 'R') slide(r, c, dirs.R);
            if(type === 'B') slide(r, c, dirs.B);
            if(type === 'Q') slide(r, c, [...dirs.R, ...dirs.B]);
            if(type === 'N') dirs.N.forEach(m => step(r+m[0], c+m[1]));
            if(type === 'K') {
                [...dirs.R, ...dirs.B].forEach(m => step(r+m[0], c+m[1]));
                if(myColor === 'white' && r === 0) { if(c === 2) highlight('t-0-2'); if(c === 5) highlight('t-0-5'); }
                if(myColor === 'black' && r === 7) { if(c === 2) highlight('b-7-2'); if(c === 5) highlight('b-7-5'); }
            }
            if(type === 'P') {
                let d = (p === 'P') ? -1 : 1, start = (p === 'P') ? 6 : 1;
                if(!hasPiece(`${r+d}-${c}`)) { highlight(`${r+d}-${c}`); if(r === start && !hasPiece(`${r+2*d}-${c}`)) highlight(`${r+2*d}-${c}`); }
                [1,-1].forEach(side => { let tid = `${r+d}-${c+side}`; if(hasPiece(tid) && !isOwnPieceAt(tid)) highlight(tid); });
            }
        }

        function slide(r, c, dirs) {
            dirs.forEach(d => {
                let nr=r+d[0], nc=c+d[1];
                while(nr>=0 && nr<8 && nc>=0 && nc<8) {
                    let tid = `${nr}-${nc}`;
                    if(!hasPiece(tid)) { highlight(tid); } else { if(!isOwnPieceAt(tid)) highlight(tid); break; }
                    nr+=d[0]; nc+=d[1];
                }
            });
        }

        function step(r, c) { if(r>=0 && r<8 && c>=0 && c<8) { let tid = `${r}-${c}`; if(!hasPiece(tid) || !isOwnPieceAt(tid)) highlight(tid); } }
        function highlight(id) { const el = document.getElementById(id); if(el) el.classList.add('possible'); }
        function hasPiece(id) { let el = document.getElementById(id); return el && el.innerHTML !== ''; }
        function isOwnPieceAt(id) { let el = document.getElementById(id); return el && el.querySelector('img') && isOwn(el.querySelector('img').dataset.piece); }

        // Update de applyMove functie
		function applyMove(f, t, p, isRemote = false) {
		    const fromEl = document.getElementById(f);
		    const toEl = document.getElementById(t);
		    let capturedPiece = null;

		    if(toEl.innerHTML !== '') {
		        capturedPiece = toEl.querySelector('img').dataset.piece;
		        addCapturedPiece(capturedPiece);
		    }

		    // Markeer laatste zet
		    document.querySelectorAll('.sq').forEach(s => s.classList.remove('last-move'));
		    fromEl.classList.add('last-move');
		    toEl.classList.add('last-move');

		    toEl.innerHTML = `<img src="${imgs[p]}" data-piece="${p}">`;
		    fromEl.innerHTML = '';

		    turn = turn === 'white' ? 'black' : 'white';
		    startTimer(); // Reset timer bij elke zet
		    clearHighlights();
		    updateUI();

		    // Sla status op server op
		    if (!isRemote) {
		        socket.emit('updateBoard', { room, board: getBoardState() });
		    }
		}

		function addCapturedPiece(p) {
		    const color = p === p.toUpperCase() ? 'black' : 'white'; // Als wit stuk (hoofdletter) wordt geslagen, gaat het naar de zwarte kant
		    const container = document.getElementById(`captured-${color}`);
		    const img = document.createElement('img');
		    img.src = imgs[p];
		    container.appendChild(img);
		}

		function getBoardState() {
		    const state = {};
		    document.querySelectorAll('.sq').forEach(sq => {
		        const img = sq.querySelector('img');
		        if (img) state[sq.id] = img.dataset.piece;
		    });
		    return state;
		}

		// Luister naar herstel-data van de server
		socket.on('syncState', (state) => {
		    // Herstel bord
		    Object.keys(state.board).forEach(id => {
		        const p = state.board[id];
		        document.getElementById(id).innerHTML = `<img src="${imgs[p]}" data-piece="${p}">`;
		    });
		    // Herstel geslagen stukken
		    state.captured.white.forEach(p => addCapturedPiece(p));
		    state.captured.black.forEach(p => addCapturedPiece(p));
		    turn = state.turn;
		    gameActive = true;
		    startTimer();
		    updateUI();
});

        function checkCheckStatus() {
            document.querySelectorAll('.sq').forEach(s => s.classList.remove('in-check'));
            const kingChar = turn === 'white' ? 'K' : 'k';
            let kingSq = null;
            document.querySelectorAll('.sq').forEach(s => { if(s.querySelector('img')?.dataset.piece === kingChar) kingSq = s; });
            // In een volledige versie zou hier de aanval-check komen.
            // Voor nu markeren we de beurt-status.
        }

        function checkVictoryConditions(id, p) {
            if((p === 'K' && id.startsWith('t')) || (p === 'k' && id.startsWith('b'))) {
                const winnerColor = p === 'K' ? 'WIT' : 'ZWART';
                socket.emit('gameOver', { room, winner: winnerColor });
                declareWinner(winnerColor);
            }
        }

        function declareWinner(color) {
            const s = document.getElementById('status');
            s.innerText = `${color} HEEFT GEWONNEN!`;
            escapeSound.currentTime = 0;
       		escapeSound.play();
            s.className = 'status-win';
            gameActive = false;
        }

        function clearHighlights() { document.querySelectorAll('.sq, .extra-sq').forEach(s => s.classList.remove('selected', 'possible')); selectedId = null; }

        function updateUI() {
            if(!gameActive) return;
            const s = document.getElementById('status');
            s.innerText = turn === myColor ? "JOUW BEURT" : "WACHTEN OP TEGENSTANDER...";
            s.style.borderColor = turn === 'white' ? 'white' : '#888';
        }

        init();
    </script>
</body>
</html>